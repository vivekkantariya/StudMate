{% extends 'layout.html' %}
{% load static %}

{% block content %}
<style>
/* Reset and Base Styles */
* {
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background-color: #f5f6fa;
    color: #333;
    line-height: 1.6;
}

/* Container */
.content-edit-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Header Styles */
.edit-header {
    background: white;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
}

.edit-title {
    font-size: 28px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.edit-subtitle {
    color: #7f8c8d;
    font-size: 16px;
    margin: 0;
}

.header-actions .btn {
    padding: 10px 20px;
    border: 1px solid #ddd;
    background: white;
    color: #666;
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.header-actions .btn:hover {
    background: #f8f9fa;
    border-color: #bbb;
    color: #333;
}

/* Main Content Layout */
.edit-content-wrapper {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    align-items: start;
}

.edit-card {
    background: white;
    border-radius: 8px;
    padding: 32px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.edit-sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Form Styles */
.form-section {
    margin-bottom: 32px;
}

.form-group {
    margin-bottom: 24px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #2c3e50;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-label i {
    color: #7f8c8d;
    width: 16px;
    text-align: center;
}

/* Form Controls */
input[type="text"],
input[type="email"],
input[type="password"],
textarea,
select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e1e8ed;
    border-radius: 6px;
    font-size: 15px;
    transition: all 0.3s ease;
    background: white;
    font-family: inherit;
}

input[type="text"]:focus,
input[type="email"]:focus,
input[type="password"]:focus,
textarea:focus,
select:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

textarea {
    resize: vertical;
    min-height: 100px;
}

.form-text {
    display: block;
    margin-top: 6px;
    font-size: 13px;
    color: #7f8c8d;
}

/* Form Row for Side-by-Side Fields */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

/* File Upload Styles */
.current-file {
    margin-bottom: 16px;
}

.file-preview {
    display: flex;
    align-items: center;
    padding: 16px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    gap: 12px;
}

.file-preview i {
    color: #dc3545;
    font-size: 24px;
    width: 32px;
    text-align: center;
}

.file-info {
    flex: 1;
}

.file-name {
    display: block;
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 2px;
}

.file-size {
    font-size: 13px;
    color: #7f8c8d;
}

.file-actions {
    display: flex;
    gap: 8px;
}

.file-actions button, 
.file-actions a {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    font-size: 14px;
    transition: all 0.3s ease;
    color: white;
}

.download-btn {
    background: #28a745;
}

.download-btn:hover {
    background: #218838;
    color: white;
}

.remove-file-btn {
    background: #dc3545;
}

.remove-file-btn:hover {
    background: #c82333;
}

.no-file {
    padding: 16px;
    text-align: center;
    color: #7f8c8d;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
}

/* Upload Area */
.file-upload {
    margin-top: 8px;
}

.upload-area {
    border: 2px dashed #d1d9e6;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    background: #fafbfc;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: #3498db;
    background: #f0f8ff;
}

.upload-area.has-file {
    border-color: #28a745;
    background: #f8fff8;
}

.upload-area i {
    font-size: 32px;
    color: #7f8c8d;
    display: block;
    margin-bottom: 12px;
}

.upload-text {
    display: block;
    font-size: 16px;
    color: #2c3e50;
    margin-bottom: 4px;
    font-weight: 500;
}

.upload-hint {
    font-size: 14px;
    color: #7f8c8d;
}

.selected-file {
    margin-top: 12px;
    padding: 12px 16px;
    background: #e8f5e8;
    border: 1px solid #c3e6c3;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.selected-file i {
    color: #28a745;
    font-size: 18px;
}

.clear-selection {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 14px;
    margin-left: auto;
}

.clear-selection:hover {
    background: #c82333;
}

/* Checkbox Styles */
.form-checkbox {
    margin-top: 8px;
}

.checkbox-container {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.checkbox-container input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    margin-top: 2px;
}

.checkbox-container label {
    margin: 0;
    cursor: pointer;
    flex: 1;
    font-weight: 500;
    color: #2c3e50;
}

/* Form Actions */
.form-actions {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    font-family: inherit;
}

.btn-primary,
.btn-save {
    background: #3498db;
    color: white;
}

.btn-primary:hover,
.btn-save:hover {
    background: #2980b9;
}

.btn-outline-danger,
.btn-delete {
    background: white;
    color: #dc3545;
    border: 1px solid #dc3545;
}

.btn-outline-danger:hover,
.btn-delete:hover {
    background: #dc3545;
    color: white;
}

/* Sidebar Styles */
.sidebar-card {
    background: white;
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.sidebar-title {
    font-size: 18px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.sidebar-title i {
    color: #7f8c8d;
    width: 20px;
    text-align: center;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f1f2f6;
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 500;
    color: #7f8c8d;
}

.info-value {
    color: #2c3e50;
    font-weight: 500;
}

.tips-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.tips-list li {
    padding: 10px 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: #2c3e50;
    font-size: 14px;
}

.tips-list i {
    color: #28a745;
    font-size: 14px;
    width: 16px;
    text-align: center;
}

/* Error Messages */
.error-messages {
    margin-top: 8px;
}

.error-messages small,
.text-danger {
    color: #dc3545;
    font-size: 13px;
    display: block;
    margin-top: 4px;
}

/* Responsive Design */
@media (max-width: 992px) {
    .edit-content-wrapper {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .edit-card {
        padding: 24px;
    }
}

@media (max-width: 768px) {
    .content-edit-container {
        padding: 16px;
    }
    
    .edit-header {
        padding: 20px;
        flex-direction: column;
        align-items: stretch;
        text-align: center;
    }
    
    .header-actions {
        margin-top: 16px;
    }
    
    .header-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .edit-card {
        padding: 20px;
    }
    
    .sidebar-card {
        padding: 20px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .upload-area {
        padding: 30px 16px;
    }
    
    .edit-title {
        font-size: 24px;
    }
}

@media (max-width: 480px) {
    .content-edit-container {
        padding: 12px;
    }
    
    .edit-header {
        padding: 16px;
    }
    
    .edit-title {
        font-size: 22px;
    }
    
    .edit-card {
        padding: 16px;
    }
    
    .sidebar-card {
        padding: 16px;
    }
    
    .upload-area {
        padding: 24px 12px;
    }
    
    .upload-area i {
        font-size: 28px;
    }
    
    .file-preview {
        padding: 12px;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .file-actions {
        width: 100%;
        justify-content: center;
    }
}

/* Focus and Accessibility */
*:focus {
    outline: 2px solid #3498db;
    outline-offset: 2px;
}

button:focus,
.btn:focus,
input:focus,
textarea:focus,
select:focus {
    outline: 2px solid #3498db;
    outline-offset: 2px;
}

/* Loading and Disabled States */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Print Styles */
@media print {
    .edit-header,
    .form-actions,
    .edit-sidebar {
        display: none;
    }
    
    .edit-content-wrapper {
        grid-template-columns: 1fr;
    }
    
    .edit-card {
        box-shadow: none;
        border: 1px solid #ddd;
    }
}
</style>

<div class="content-edit-container">
    <div class="edit-header">
        <div class="header-content">
            <h1 class="edit-title">
                <i class="fas fa-edit me-2"></i> Edit Content
            </h1>
            <p class="edit-subtitle">Update your content details and files</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'content_detail' content.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-1"></i> Cancel
            </a>
        </div>
    </div>

    <div class="edit-content-wrapper">
        <div class="edit-card">
            <form method="post" enctype="multipart/form-data" class="edit-form" id="editForm">
                {% csrf_token %}

                <div class="form-section">
                    <div class="form-group">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            <i class="fas fa-heading me-2"></i> Title
                        </label>
                        {{ form.name }}
                        <small class="form-text">Give your content a clear, descriptive title</small>
                        {% if form.name.errors %}
                            <div class="error-messages">
                                {% for error in form.name.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.desc.id_for_label }}" class="form-label">
                            <i class="fas fa-align-left me-2"></i> Description
                        </label>
                        {{ form.desc }}
                        <small class="form-text">Provide details about what this content contains</small>
                        {% if form.desc.errors %}
                            <div class="error-messages">
                                {% for error in form.desc.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="{{ form.content_type.id_for_label }}" class="form-label">
                                <i class="fas fa-tag me-2"></i> Content Type
                            </label>
                            {{ form.content_type }}
                            {% if form.content_type.errors %}
                                <div class="error-messages">
                                    {% for error in form.content_type.errors %}
                                        <small class="text-danger">{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.tags.id_for_label }}" class="form-label">
                                <i class="fas fa-tags me-2"></i> Tags
                            </label>
                            {{ form.tags }}
                            <small class="form-text">Separate tags with commas (e.g., math, algebra)</small>
                            {% if form.tags.errors %}
                                <div class="error-messages">
                                    {% for error in form.tags.errors %}
                                        <small class="text-danger">{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-file me-2"></i> Current File
                        </label>
                        <div class="current-file" id="currentFileSection">
                            {% if content.file %}
                            <div class="file-preview" id="currentFilePreview">
                                <i class="fas fa-file-pdf"></i>
                                <div class="file-info">
                                    <span class="file-name">{{ content.file.name|truncatechars:30 }}</span>
                                    <span class="file-size">{{ content.file.size|filesizeformat }}</span>
                                </div>
                                <div class="file-actions">
                                    <a href="{{ content.file.url }}" class="download-btn" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <button type="button" class="remove-file-btn" id="removeFileBtn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            {% else %}
                            <div class="no-file">
                                <i class="fas fa-exclamation-circle"></i> No file uploaded
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_file" class="form-label">
                            <i class="fas fa-file-upload me-2"></i> 
                            {% if content.file %}Replace File{% else %}Upload File{% endif %}
                        </label>
                        
                        <!-- Hidden file input -->
                        {{ form.file }}
                        
                        <!-- Custom upload area -->
                        <div class="file-upload">
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span class="upload-text">Click to browse or drag & drop</span>
                                <span class="upload-hint">Supports: PDF, DOCX, ZIP (Max 10MB)</span>
                            </div>
                        </div>
                        
                        <!-- Display selected file name -->
                        <div class="selected-file" id="selectedFileDisplay" style="display: none;">
                            <i class="fas fa-file"></i>
                            <span id="selectedFileName"></span>
                            <span id="selectedFileSize"></span>
                            <button type="button" class="clear-selection" id="clearFileBtn">×</button>
                        </div>
                        
                        {% if form.file.errors %}
                            <div class="error-messages">
                                {% for error in form.file.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Hidden field to track file removal -->
                        <input type="hidden" name="remove_file" id="removeFileFlag" value="false">
                    </div>

                    <div class="form-group form-checkbox">
                        <label for="{{ form.is_public.id_for_label }}" class="form-label">
                            <i class="fas fa-globe me-2"></i> Visibility
                        </label>
                        <div class="checkbox-container">
                            {{ form.is_public }}
                            <label for="{{ form.is_public.id_for_label }}">Make this content public</label>
                            <small class="form-text">Public content can be viewed by anyone</small>
                        </div>
                        {% if form.is_public.errors %}
                            <div class="error-messages">
                                {% for error in form.is_public.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-save">
                        <i class="fas fa-save me-2"></i> Save Changes
                    </button>

                    <a href="{% url 'content_delete' content.id %}" class="btn btn-outline-danger btn-delete">
                        <i class="fas fa-trash-alt me-2"></i> Delete
                    </a>
                </div>

            </form>
        </div>

        <div class="edit-sidebar">
            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    <i class="fas fa-info-circle me-2"></i> Content Information
                </h3>
                <div class="info-item">
                    <span class="info-label">Created:</span>
                    <span class="info-value">{{ content.date|date:"M d, Y" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Updated:</span>
                    <span class="info-value">{{ content.updated_at|date:"M d, Y" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Downloads:</span>
                    <span class="info-value">{{ content.download_count }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Rating:</span>
                    <span class="info-value">{{ content.rate }}/5</span>
                </div>
            </div>

            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    <i class="fas fa-lightbulb me-2"></i> Best Practices
                </h3>
                <ul class="tips-list">
                    <li>
                        <i class="fas fa-check-circle"></i>
                        Use clear and specific titles
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        Include relevant keywords in description
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        Choose appropriate content type
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        Add multiple tags for better discoverability
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('id_file');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const removeFileFlag = document.getElementById('removeFileFlag');
        const currentFileSection = document.getElementById('currentFileSection');
        const currentFilePreview = document.getElementById('currentFilePreview');
        const selectedFileDisplay = document.getElementById('selectedFileDisplay');
        const selectedFileName = document.getElementById('selectedFileName');
        const selectedFileSize = document.getElementById('selectedFileSize');
        const clearFileBtn = document.getElementById('clearFileBtn');

        // Hide the default file input
        fileInput.style.display = 'none';

        // Make upload area clickable
        uploadArea.addEventListener('click', function() {
            fileInput.click();
        });

        // Handle file removal
        if (removeFileBtn) {
            removeFileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Are you sure you want to remove the current file?')) {
                    // Hide current file preview
                    if (currentFilePreview) {
                        currentFilePreview.style.display = 'none';
                    }
                    
                    // Set removal flag
                    removeFileFlag.value = 'true';
                    
                    // Show no-file message
                    currentFileSection.innerHTML = `
                        <div class="no-file">
                            <i class="fas fa-exclamation-circle"></i> File will be removed on save
                        </div>
                    `;
                    
                    // Clear file input and selected file display
                    fileInput.value = '';
                    selectedFileDisplay.style.display = 'none';
                    resetUploadArea();
                }
            });
        }

        // Clear file selection
        if (clearFileBtn) {
            clearFileBtn.addEventListener('click', function() {
                fileInput.value = '';
                selectedFileDisplay.style.display = 'none';
                resetUploadArea();
                removeFileFlag.value = 'false';
            });
        }

        function resetUploadArea() {
            uploadArea.innerHTML = `
                <i class="fas fa-cloud-upload-alt"></i>
                <span class="upload-text">Click to browse or drag & drop</span>
                <span class="upload-hint">Supports: PDF, DOCX, ZIP (Max 10MB)</span>
            `;
            uploadArea.classList.remove('has-file');
        }

        // Handle drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#3498db';
            uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ddd';
            uploadArea.style.backgroundColor = '#f9f9f9';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ddd';
            uploadArea.style.backgroundColor = '#f9f9f9';

            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                updateFilePreview();
            }
        });

        // Handle file selection
        fileInput.addEventListener('change', function() {
            console.log('File input changed:', this.files);
            updateFilePreview();
        });

        function updateFilePreview() {
            if (fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                console.log('Selected file:', file);
                
                const fileSize = file.size > 1024 * 1024
                    ? (file.size / (1024 * 1024)).toFixed(2) + ' MB'
                    : (file.size / 1024).toFixed(2) + ' KB';

                // Show selected file
                selectedFileName.textContent = file.name;
                selectedFileSize.textContent = `(${fileSize})`;
                selectedFileDisplay.style.display = 'block';
                
                // Update upload area
                uploadArea.innerHTML = `
                    <i class="fas fa-file-alt"></i>
                    <span class="upload-text">File selected: ${file.name}</span>
                    <span class="upload-hint">${fileSize}</span>
                `;
                uploadArea.classList.add('has-file');
                
                // Reset removal flag if a new file is selected
                removeFileFlag.value = 'false';
            } else {
                resetUploadArea();
                selectedFileDisplay.style.display = 'none';
            }
        }

        // Delete confirmation
        document.querySelector('.btn-delete').addEventListener('click', function (e) {
            if (!confirm('Are you sure you want to delete this content? This action cannot be undone.')) {
                e.preventDefault();
            }
        });

        // Form submission debugging
        document.getElementById('editForm').addEventListener('submit', function(e) {
            const hasCurrentFile = {{ content.file|yesno:"true,false" }};
            const hasNewFile = fileInput.files && fileInput.files.length > 0;
            const isRemoving = removeFileFlag.value === 'true';
            
            console.log('Form submission debug:', {
                hasCurrentFile: hasCurrentFile,
                hasNewFile: hasNewFile,
                isRemoving: isRemoving,
                removeFileFlag: removeFileFlag.value,
                files: fileInput.files
            });
            
            // Check if user is trying to remove file without adding new one
            if (hasCurrentFile && isRemoving && !hasNewFile) {
                if (!confirm('You are removing the current file without adding a new one. The content will have no file attached. Continue?')) {
                    e.preventDefault();
                    return;
                }
            }
        });
    });
</script>

{% endblock %}